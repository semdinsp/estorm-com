Needs["dmdash`"];
Needs["dreamUtilities`"];
selectRCPerDM[dm_String, rows_List] := 
  Module[{mds}, mds = selectPattern[rows, {_, _, _, _, dm, __}]; 
   mds];
selectIncrement[rows_List] :=
  Module[{res}, res = selectPattern[rows, {"increment", __}]; res];
getLatestRCPerDM[dm_String, releasecashes_List] := 
  Module[{res}, res = selectRCPerDM[dm, releasecashes];
   If[Length[res] == 0, $Failed, First[res]]];
checkIfOldReleaseCash[dm_String, releasecashes_List] := 
  Module[{latestRC, rcdate},
   latestRC = getLatestRCPerDM[dm, releasecashes];
   rcdate = DateObject[{2006, 12}];
   If[Head[latestRC] == List, rcdate = DateObject[latestRC[[13]]]];
    If[DateDifference[rcdate, DateObject[]] > Quantity[8, "Days"], 
    True, False]];
rcPerDM[dm_String, rows_List] := 
  Module[{data, res}, data = selectRCPerDM[dm, rows]; 
   res = Total[data];
   res[[8]]];
dmRCPerformance[rows_List, dms_List] := Module[{res},
   res = {#, rcPerDM[#, rows] } & /@ dms;
   res
   ];
{day, rows, allrows, month} = getWalletRows[]; rowsLowBalance = 
 Select[rows, #[[1]] < 0.75* #[[6]] &];
dms = dmlist[rows];
r = getReleaseCash[]; r = r[[3 ;;]]; r = 
 selectIncrement[r]; inactiveWallets = 
 Map[If[checkIfOldReleaseCash[ToString[#[[2]]], 
     r], {#[[1]], #[[2]], #[[4]] }, Nothing] &, rowsLowBalance];
dmRCPerf = dmRCPerformance[r, dms];
dmRCgrid = 
  Grid[Prepend[{#[[1]], -#[[2]]} & /@ dmRCPerf, {"DM",   
     "Total Release Cash 30 days"}], Frame -> All, 
   Background -> {None, {LightBlue, {LightYellow}}}];
grid = Grid[
   Prepend[{#[[1]], #[[2]], #[[3]]} & /@ 
     inactiveWallets, {"Wallet Balance",   "MD", "DM"}], Frame -> All,
    Background -> {None, {LightBlue, {LightYellow}}}];
frags = {Style["Release Cash per DM over last 30 days", Blue], 
   dmRCgrid, 
   Style[StringJoin["Wallets with No cash release in 8 days: ", 
     DateString[]], Blue], grid, closingData[]};
cc = {"eka.mardiarti@estormtech.com", "scott.sproule@estormtech.com", 
   "henricos@estormtech.com", "belo@estormtech.com"};

estormAWSSendEmail[{"emiliana@estormtech.com"}, cc, {}, 
  "Daily Release Cash Report", combineHTMLFragments[frags]];
  
Quit[];