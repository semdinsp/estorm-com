Needs["estormdash`"]; 
Needs["dmdash`"]; 
Needs["dreamUtilities`"];
processTime[rows_List] :=  Module[{newrows}, 
  newrows = {StringTake[#[[3]], 10], #[[6]]} & /@ rows; newrows];
getSmsReport[app_String, lastmonth_String] := 
  Module[{report, header, rows, gathered, gmap, grid},
   report = getRawSmsReport[app, lastmonth];
   header = report[[1]];
   rows = report[[3 ;;]];
   gathered = Gather[processTime[rows]];
   gmap = 
    Map[{gathered[[#, 1, 1]], Total[gathered, {2}][[#, 2]]} &, 
     Table[i, {i, 1, Length[gathered]}]];
   grid = 
    Grid[Prepend[{#[[1]], #[[2]]} & /@ gmap, {"Date",   "$ Value"}], 
     Frame -> All, Background -> {None, {LightBlue, {LightYellow}}}];
   {grid, header, rows, gmap}];
buildSMSReport[name_String] := 
  Module[{fragments, grid, header, rows, gmap}, fragments = {};
   {grid, header, rows, gmap} = getSmsReport[name, "false"];
   fragments = 
    Append[fragments, {Style[
       StringJoin[name, " Report Current Month: $", 
        ToString[Total[gmap][[2]]]], Blue], grid}];
   {grid, header, rows, gmap} = 
    getSmsReport[name, "true"];  (*last month *)  
   fragments = 
    Append[fragments, {Style[
       StringJoin[name, " Report Last Month: $", 
        ToString[Total[gmap][[2]]]], Blue], grid}];
   fragments];

names = {"SantaSms", "Lotto4d", "Lotto3d", "Bible", "SmsCommands"};
frags = buildSMSReport[#]  & /@ names;
frags = Append[frags, closingData[]];

to = {"febby@estormtech.com", "helio@estormtech.com" ,"randy@melon.co.id"};
(* If[DayName[Today] == Friday, to = Append[to, "randy@melon.co.id"]];  *)
cc = {"eka.mardiarti@estormtech.com", "scott.sproule@estormtech.com", 
   "emiliana@estormtech.com"};

estormAWSSendEmail[to, cc, {}, "SMS Reporting", 
  combineHTMLFragments[Flatten[frags]]];

Needs["estormdash`"]; Needs["dmdash`"];
Needs["dreamUtilities`"];
tdbin = Databin["4zEg8Ybn"];
monthlydata = estormdash`getMonth["summary"];
monthly = estormdash`getMonth["transactions"];
trev = NumberForm[
   ToExpression[Last[EventSeries[tdbin]["revenue"]["Values"]]], {5, 
    2}];
td = TemporalData[monthly["Monthly"]] ; tsmodel = 
 TimeSeriesModelFit[td, "ARIMA"]; forecast = 
 TimeSeriesForecast[
  tsmodel, {20}];(* \
p1=DateListPlot[{td,forecast,MovingAverage[td,12]},PlotLabel\[Rule] \
"Daily Revenue in $",PlotLegends\[Rule]{"actuals","forecast","moving \
average"},ImageSize\[Rule] Medium]; *)

p1 = DateListPlot[{td}, PlotLabel -> "Daily Revenue in $", 
   PlotLegends -> {"actuals"}, ImageSize -> Medium];
mgraph = p1;(* \
Show[p1,DateListPlot[RandomFunction[tsmodel,{1,20},2],PlotStyle\[Rule]\
{Gray,Pink}]];  *)

labeler[v_, {i_, j_}, {ri_, cj_}] := Placed[v, Top]; labels = 
 StringDrop[#[[1]], -3] & /@ 
  monthlydata["Monthly Summary"]; msummary = 
 BarChart[TemporalData[monthlydata["Monthly Summary"]], 
  PlotLabel -> "Revenue by month", ImageSize -> Large, 
  ChartLabels -> Sort[labels], LabelingFunction -> labeler];
frags = {{Style[StringJoin["Revenue ", ToString[trev]], Blue, Bold, 
     24]}, {msummary}, {estormdash`plotDatabin[tdbin, "revenue"], 
    estormdash`plotDatabin[tdbin, 
     "distributors"]}, {estormdash`plotDatabin[tdbin, 
     "transactionUcount"]}};
frags = Append[frags, closingData[]];

to = {"scott.sproule@estormtech.com"};  
cc = {"eka.mardiarti@estormtech.com", "michael.grandinetti@sea-ent.com"}

estormAWSSendEmail[to, cc, {}, "S&A Reporting", 
  combineHTMLFragments[Flatten[frags]]];  
  
Quit[];