Needs["estormdash`"]; 
Needs["dmdash`"]; 
Needs["dreamUtilities`"];
processTime[rows_List] :=  Module[{newrows}, 
  newrows = {StringTake[#[[3]], 10], #[[6]]} & /@ rows; newrows];
getSmsReport[app_String, lastmonth_String] := 
  Module[{report, header, rows, gathered, gmap, grid},
   report = getRawSmsReport[app, lastmonth];
   header = report[[1]];
   rows = report[[3 ;;]];
   gathered = Gather[processTime[rows]];
   gmap = 
    Map[{gathered[[#, 1, 1]], Total[gathered, {2}][[#, 2]]} &, 
     Table[i, {i, 1, Length[gathered]}]];
   grid = 
    Grid[Prepend[{#[[1]], #[[2]]} & /@ gmap, {"Date",   "$ Value"}], 
     Frame -> All, Background -> {None, {LightBlue, {LightYellow}}}];
   {grid, header, rows, gmap}];
buildSMSReport[name_String] := 
  Module[{fragments, grid, header, rows, gmap}, fragments = {};
   {grid, header, rows, gmap} = getSmsReport[name, "false"];
   fragments = 
    Append[fragments, {Style[
       StringJoin[name, " Report Current Month: $", 
        ToString[Total[gmap][[2]]]], Blue], grid}];
   {grid, header, rows, gmap} = 
    getSmsReport[name, "true"];  (*last month *)  
   fragments = 
    Append[fragments, {Style[
       StringJoin[name, " Report Last Month: $", 
        ToString[Total[gmap][[2]]]], Blue], grid}];
   fragments];

names = {"SantaSms", "Lotto4d", "Lotto3d", "Bible", "SmsCommands"};
frags = buildSMSReport[#]  & /@ names;
frags = Append[frags, closingData[]];

to = {"febby@estormtech.com", "helio@estormtech.com"};
If[DayName[Today] == Friday, to = Append[to, "randy@melon.co.id"]];
cc = {"eka.mardiarti@estormtech.com", "scott.sproule@estormtech.com", 
   "emiliana@estormtech.com"};

estormAWSSendEmail[to, cc, {}, "SMS Reporting", 
  combineHTMLFragments[Flatten[frags]]];
Quit[];